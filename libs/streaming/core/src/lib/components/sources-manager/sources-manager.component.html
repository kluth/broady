<mat-card class="sources-manager">
  <mat-card-header>
    <mat-card-title>Sources</mat-card-title>
    <button mat-raised-button color="primary" (click)="openAddDialog()" class="add-button">
      <mat-icon>add</mat-icon>
      Add Source
    </button>
  </mat-card-header>

  <mat-card-content>
    @if (activeScene()) {
      <mat-list class="sources-list">
        @for (source of sceneSources(); track source.id) {
          <mat-list-item
            class="source-item"
            [class.selected]="selectedSourceId() === source.id"
            [class.dragging]="draggedSourceId() === source.id"
            [class.invisible]="!source.visible"
            (click)="selectSource(source.id)"
            draggable="true"
            (dragstart)="onDragStart(source.id, $event)"
            (dragover)="onDragOver($event)"
            (drop)="onDrop(source.id, $event)"
            (dragend)="onDragEnd()"
          >
            <mat-icon matListItemIcon>{{ getSourceIcon(source.type) }}</mat-icon>
            <div matListItemTitle>{{ source.name }}</div>
            <div matListItemLine>{{ source.type }}</div>
            <div matListItemMeta class="source-controls">
              <button
                mat-icon-button
                [color]="source.visible ? 'primary' : 'basic'"
                (click)="toggleSourceVisibility(source.id); $event.stopPropagation()"
                [matTooltip]="source.visible ? 'Hide' : 'Show'"
              >
                <mat-icon>{{ source.visible ? 'visibility' : 'visibility_off' }}</mat-icon>
              </button>
              <button
                mat-icon-button
                [color]="source.locked ? 'warn' : 'basic'"
                (click)="toggleSourceLock(source.id); $event.stopPropagation()"
                [matTooltip]="source.locked ? 'Unlock' : 'Lock'"
              >
                <mat-icon>{{ source.locked ? 'lock' : 'lock_open' }}</mat-icon>
              </button>
            </div>
          </mat-list-item>
        } @empty {
          <div class="empty-state">
            <mat-icon class="empty-icon">layers</mat-icon>
            <p>No sources in this scene</p>
            <button mat-raised-button color="accent" (click)="openAddDialog()">
              <mat-icon>add</mat-icon>
              Add Your First Source
            </button>
          </div>
        }
      </mat-list>

      @if (hasSelectedSource()) {
        <div class="source-actions">
          <button
            mat-mini-fab
            color="primary"
            (click)="moveSourceUp(selectedSourceId()!)"
            matTooltip="Move Up"
          >
            <mat-icon>arrow_upward</mat-icon>
          </button>
          <button
            mat-mini-fab
            color="primary"
            (click)="moveSourceDown(selectedSourceId()!)"
            matTooltip="Move Down"
          >
            <mat-icon>arrow_downward</mat-icon>
          </button>
          <button
            mat-mini-fab
            color="primary"
            (click)="duplicateSource(selectedSourceId()!)"
            matTooltip="Duplicate"
          >
            <mat-icon>content_copy</mat-icon>
          </button>
          <button
            mat-mini-fab
            color="primary"
            (click)="renameSource(selectedSourceId()!)"
            matTooltip="Rename"
          >
            <mat-icon>edit</mat-icon>
          </button>
          <button
            mat-mini-fab
            color="warn"
            (click)="removeSource(selectedSourceId()!)"
            matTooltip="Remove"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      }
    } @else {
      <div class="no-scene">
        <mat-icon class="empty-icon">error_outline</mat-icon>
        <p>No active scene selected</p>
      </div>
    }
  </mat-card-content>

  <!-- Add Source Dialog -->
  @if (showAddDialog()) {
    <div class="dialog-overlay" (click)="closeAddDialog()">
      <mat-card class="add-source-dialog" (click)="$event.stopPropagation()">
        <mat-card-header>
          <mat-card-title>Add Source</mat-card-title>
          <button mat-icon-button class="close-button" (click)="closeAddDialog()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Source Name</mat-label>
            <input
              matInput
              [value]="newSourceName()"
              (input)="updateSourceName($any($event.target).value)"
              placeholder="Enter source name..."
              autofocus
            />
          </mat-form-field>

          <div class="source-type-label">
            <mat-label>Source Type</mat-label>
          </div>

          <div class="source-type-categories">
            @for (category of ['video', 'audio', 'media', 'other']; track category) {
              <div class="type-category">
                <h4 class="category-name">
                  {{ category === 'video' ? 'Video' :
                     category === 'audio' ? 'Audio' :
                     category === 'media' ? 'Media' : 'Other' }}
                </h4>
                <mat-chip-listbox class="type-chips">
                  @for (type of categorizedSourceTypes()[category]; track type.type) {
                    <mat-chip-option
                      [selected]="selectedSourceType() === type.type"
                      (click)="selectSourceType(type.type)"
                    >
                      <span class="chip-content">
                        <span class="type-icon">{{ type.icon }}</span>
                        <span class="type-info">
                          <span class="type-name">{{ type.name }}</span>
                          <span class="type-desc">{{ type.description }}</span>
                        </span>
                      </span>
                    </mat-chip-option>
                  }
                </mat-chip-listbox>
              </div>
            }
          </div>
        </mat-card-content>

        <mat-card-actions align="end">
          <button mat-button (click)="closeAddDialog()">
            Cancel
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="addSource()"
            [disabled]="!newSourceName().trim()"
          >
            Add Source
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  }
</mat-card>
